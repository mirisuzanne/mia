{% import "utility.macros.njk" as utility %}
{% import "cards.macros.njk" as cards %}

{% macro section(
  title,
  events,
  all,
  self
) %}
  {% call cards.section(title) %}
    {% for segment in events %}
      {{ group(
        title=segment.group,
        events=segment.data,
        all=all,
        self=self
      ) }}
    {% endfor %}
  {% endcall %}
{% endmacro %}

{% macro group(
  title,
  events,
  all,
  self
) %}
  {% set is_future = (title == 'soon') %}

  {% call cards.group(title) %}
    {{ list(
      events=events,
      reverse=not is_future,
      all=all,
      self=self
    ) }}
  {% endcall %}

  {% if is_future and not loop.last %}
    <hr data-divider>
  {% endif %}
{% endmacro %}

{% macro list(
  events,
  reverse,
  all,
  self
) %}
  {% call cards.list(reverse) %}
    {% set events = events | reverse if reverse else events %}
    {% for item in events %}
      {{ event(
        item=item,
        all=all,
        self=self
      ) }}
    {% endfor %}
  {% endcall %}
{% endmacro %}

{% macro event(
  item,
  all,
  self
) %}
  {% set feature = item.event.feature or item.page.data.feature %}
  {% set tags = item.page.data.tags | publicTags %}
  {% set date_format = 'since' if (item.group == 4000) else 'md' %}
  {% set is_self = (item.page.url == self) %}
  {% set no_title = (is_self and not item.event.title) %}

  {# Venue Link #}
  {%- set venue_name = item.event.venue or item.page.data.venue -%}
  {%- set venue_url = item.event.url or item.page.data.url -%}
  {%- set venue = utility.link_if(venue_name, venue_url) if venue_name else none -%}
  {%- set venue = ['@', venue] | join(' ') if venue else none -%}

  {# Title Link #}
  {%- set title_name = item.event.title or item.page.data.title -%}
  {%- set not_me = ('inspiration' in tags) -%}
  {%- set url = none if is_self else item.page.url -%}
  {%- set title = utility.link_if(title_name | mdInline, url) -%}
  {%- set title = ['See Also:', title] | join(' ') if not_me else title -%}

  {# Info #}
  {% set info %}
    <time datetime="{{ item.date | getDate('iso') }}">
      {% set start = item.start | getDate('year') %}
      {% set end = item.end | getDate('year') %}
      {% if (date_format == 'since') or (start == end) %}
        {{ item.date | getDate(date_format) }}
      {% else %}
        {{ start }}—{{ end }}
      {% endif %}
    </time>
    {% if (venue and not no_title) %}
      {{ venue | safe }}
    {% elif tags %}
      » {{ utility.tag_list(tags, all, '/') }}
    {% endif %}
  {% endset %}

  {# Main #}
  {% set main = venue if (venue and no_title) else title %}

  {# Output #}
  {% call cards.item(feature) %}
    {{ cards.meta(info) }}
    {{ cards.main(main) }}
  {% endcall %}
{% endmacro %}
