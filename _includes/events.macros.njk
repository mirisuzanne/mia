{% import "utility.macros.njk" as utility %}

{% macro section(
  events,
  title=none,
  self=none
) %}
  {% set years = events | groupby('group') | dictsort | reverse %}

  <section
    data-area="full"
    data-flow="grid">

    {{ utility.section_title(title or 'calendar') }}

    <div
      data-area="full"
      data-layout="calendar">
      {% set group_formats = {
        now: 'since'
      } %}
      {% for year, segment in years %}
        {% set date_format = group_formats[year] or 'md' %}
        {{ group(year, segment, date_format, self) }}
      {% endfor %}
    </div>
  </section>
{% endmacro %}

{% macro group(
  title,
  segment,
  date_format='md',
  self=none
) %}
  {% if segment | length %}
    <section data-calendar="group">
      <h3
        data-calendar="grouper"
        data-theme="invert">
        {{ title }}
      </h3>
      {{ list(
        segment,
        date_format,
        reverse=false if (title == 'later') else true,
        self=self
      ) }}
    </section>
  {% endif %}
{% endmacro %}

{% macro list(
  events,
  date_format='md',
  reverse=true,
  self=none
) %}
  {% if events | length %}
    <ol
      data-calendar="list"
      {{ utility.attr_if('reversed', reverse) }}>
      {% set events = events | reverse if reverse else events %}
      {% for item in events %}
        {{ event(item, date_format, self) }}
      {% endfor %}
    </ol>
  {% endif %}
{% endmacro %}

{% macro event(
  item,
  date_format='md',
  self=none
) %}
  {% set feature = item.event.feature or item.page.data.feature %}
  {% set is_self = true if (item.page.url == self) else false %}
  {% set venue = item.event.venue or item.page.data.venue %}
  {% set venue_url = item.event.url or item.page.data.url %}
  {% set title = item.event.title or item.page.data.title %}
  {% set url = none if is_self else item.page.url %}

  <li
    data-calendar="item"
    {{ utility.attr_if('data-feature', feature) }}>
    <div data-item="inner">
      <div data-item="meta">
        <time data-item="date">
          {{ item.start | formatDate(date_format) }}
        </time>

        {% if venue and not is_self %}
          @
          {{ utility.link_if(venue, venue_url) }}
        {% endif %}
      </div>

      <h4 data-item="title">
        {% if venue and is_self %}
          {{ utility.link_if(venue, venue_url) }}
        {% else %}
          {{ utility.link_if(title, url) }}
        {% endif %}
      </h4>
    </div>
  </li>
{% endmacro %}

{# {% if hero %}
  <li
    data-calendar="hero">
    <a
      href="{{ url | url }}"
      style="--image: url(/assets/images/{{ hero.img }})">
      <span hidden>
        {{ hero.caption or hero.alt or title }}
      </span>
    </a>
  </li>
{% endif %} #}
